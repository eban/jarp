<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "https://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<title>Just another Ruby porter, 2015-6-c</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="nsmm v0.6.3.2(2005/08/18)">
<meta name="author" content="わたなべひろふみ">
<meta http-equiv="Content-Style-Type" content="text/css">
<META http-equiv="Content-Script-Type" content="text/javascript">
<link rel="stylesheet" href="../css/basic.css" type="text/css" media="all">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<link rel="icon" type="image/png" href="../favicon.png">
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://jarp.does.notwork.org/jarp/diary/index.rdf">
<link rev="made" href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3A;&#101;&#98;&#x61;&#110;&#64;&#x6F;&#x73;&#x2E;&#x72;&#105;&#109;&#46;&#x6F;&#x72;&#x2E;&#106;&#x70;">
<link rel="index" href="./">
<link rel="prev" href="201506b.html">
<link rel="next" href="201507a.html">

<link rel="stylesheet" type="text/css" href="https://google-code-prettify.googlecode.com/svn/trunk/src/prettify.css">
<script async type="text/javascript" src="https://google-code-prettify.googlecode.com/svn/trunk/src/prettify.js"></script>
<script type="text/javascript">
<!--       
$(document).ready(function() {
  prettyPrint();
});
-->
</script>
</head>
<body>
<div><h1><span>Just another Ruby porter,</span></h1></div>

<p>〜2015年6月下旬〜</p>
<hr>
<div>
<a href="201506b.html" accesskey=",">&lt;Older(,)</a> | 
<a href="201507a.html" accesskey=".">Newer(.)&gt;</a> | 
<a href="index.html" accesskey="/">Recent(/)&gt;&gt;</a>
| <a href="index.rdf">RDF</a>
</div>

<hr>

<!-- 2015/06/21 start -->
<h2><a name="20150621" href="201506c.html#20150621">2015-06-21 (Sun)</a></h2>

<div class="entry1">
<h3><a name="201506211" title="201506211" href="201506c.html#201506211">■</a> 
日記スクリプト</h3>
<p>
今日の日付ファイルのパスを生成するスクリプトは、<br>
今日じゃなくて前回の翌日分を生成すればいいんだと気づいた。<br>
つまり今日から順番に遡って見つかったらその次の日という感じに。<br>
そうすると一回書いて閉じると次の日になってしまうが、まあいいか。
</p>
<!-- section end -->
</div>
<!-- 2015/06/21 end -->



<hr class="hide">
<!-- 2015/06/22 start -->
<h2><a name="20150622" href="201506c.html#20150622">2015-06-22 (Mon)</a></h2>

<div class="entry1">
<h3><a name="201506221" title="201506221" href="201506c.html#201506221">■</a> 
2年半振りにTANITAの歩数計が見つかる</h3>
<p>
見つかるときは見つかるもので。<br>
fitbitの前に使っていた歩数計がひょっこり籠の中から出てきた。<br>
<a href="201212a.html#201212101">2年半</a>だ。今となってはサイズがでかすぎる。
</p>
<p>
この歩数計が311のときに見につけてもいないのに
<a href="201103b.html#201103111">19歩</a>も計測していたんだよなあ。
</p>
<!-- section end -->
</div>
<!-- 2015/06/22 end -->



<hr class="hide">
<!-- 2015/06/23 start -->
<h2><a name="20150623" href="201506c.html#20150623">2015-06-23 (Tue)</a></h2>

<div class="entry1">
<h3><a name="201506231" title="201506231" href="201506c.html#201506231">■</a> 
上総中野</h3>
<p>
ヨルタモリでやってた終着駅が、偶然今日の鉄道捜査官の再放送で出てきた。<br>
そのおかげでいきなりトリックがばればれになってしまったのがあれだが。
</p>
<!-- section end -->
</div>
<!-- 2015/06/23 end -->



<hr class="hide">
<!-- 2015/06/24 start -->
<h2><a name="20150624" href="201506c.html#20150624">2015-06-24 (Wed)</a></h2>

<div class="entry1">
<h3><a name="201506241" title="201506241" href="201506c.html#201506241">■</a> 
uBlock と ublock origin</h3>
<p>
ふと気づくとChromeではuBlock originでFirefoxではuBlockを使っていた。<br>
あれ、これって違うの？とぐぐってみるとなんかきな臭い話が。<br>
<a href="https://www.reddit.com/r/newsokur/comments/33wick/ublock">uBlockオリジナルの作者が現開発陣の運営方針を疑問視し、独自に開発存続をアナウンス</a></p>
<!-- section end -->
</div>
<!-- 2015/06/24 end -->



<hr class="hide">
<!-- 2015/06/25 start -->
<h2><a name="20150625" href="201506c.html#20150625">2015-06-25 (Thu)</a></h2>

<div class="entry1">
<h3><a name="201506251" title="201506251" href="201506c.html#201506251">■</a> 
fitbit apiを使って歩数を取得</h3>
<p>
簡単に言うと以下のURLから歩数は取得可能。日付は2015-06-01から現在までという意味。<br>
stepsを削除すれば保存してあるもろもろのアクティビティが取れる。<br>
https://api.fitbit.com/1/user/-/activities/steps/date/2015-06-01/today.json<br>
https://api.fitbit.com/1/user/-/activities/date/2015-06-01/today.json<br>
ただ、OAuthでの認証が必要なので面倒なら
<a href="https://wiki.fitbit.com/display/API/API+Explorer">API Explorer</a>を使うといいかもしれない。<br>
各種APIが簡単に呼び出せる。
</p>
<!-- section end -->
</div>
<!-- 2015/06/25 end -->



<hr class="hide">
<!-- 2015/06/26 start -->
<h2><a name="20150626" href="201506c.html#20150626">2015-06-26 (Fri)</a></h2>

<div class="entry1">
<h3><a name="201506261" title="201506261" href="201506c.html#201506261">■</a> 
fitgemで歩数情報を取得</h3>
<p>
方法は
<a href="http://fitbitclient.com/guide/playing-with-the-fitgem-api">Fitgem Reference Client</a>の通りにすればok。cunsumer_keyとcunsumer_secretは
<a href="https://dev.fitbit.com/apps/new">アプリ登録ページ</a>でもろもろ入力する。<br>
Websiteとかあるが適当にhttp://localhost/でもいけるようだ。<br>
test-fitgem.rbは最初の実行のときにPINの入力を促される。
</p>
<p>
あとtest-fitgem.rbの最後の
</p>
<pre>
pp client.activities_on_date 'today'
</pre>
<p>
を
</p>
<pre>
pp client.activity_on_date_range('steps', '2012-12-15', 'today')[&quot;activities-steps&quot;]
</pre>
<p>
のようにすれば2012-12-15にから今日までの歩数が得られる。
</p>
<pre>
% ruby test-fitgem.rb | tail
 {&quot;dateTime&quot;=&gt;&quot;2015-06-17&quot;, &quot;value&quot;=&gt;&quot;11348&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-18&quot;, &quot;value&quot;=&gt;&quot;17780&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-19&quot;, &quot;value&quot;=&gt;&quot;13734&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-20&quot;, &quot;value&quot;=&gt;&quot;972&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-21&quot;, &quot;value&quot;=&gt;&quot;1706&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-22&quot;, &quot;value&quot;=&gt;&quot;16762&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-23&quot;, &quot;value&quot;=&gt;&quot;13477&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-24&quot;, &quot;value&quot;=&gt;&quot;11458&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-25&quot;, &quot;value&quot;=&gt;&quot;2032&quot;},
 {&quot;dateTime&quot;=&gt;&quot;2015-06-26&quot;, &quot;value&quot;=&gt;&quot;2977&quot;}]
</pre>
<p>
jsonにしたければppの代わりにjjで。
</p>
<!-- section end -->
</div>
<!-- 2015/06/26 end -->



<hr class="hide">
<!-- 2015/06/27 start -->
<h2><a name="20150627" href="201506c.html#20150627">2015-06-27 (Sat)</a></h2>

<div class="entry1">
<h3><a name="201506271" title="201506271" href="201506c.html#201506271">■</a> 
PS3の音が割れる</h3>
<p>
昔はそんなことかなかったのに、ここ1年ぐらい何をしても音が割れるなと思ったら、<br>
単にプレーヤーのボリュームが最大になっていただけだった。<br>
ここは完全に盲点だった。テレビかと思ってそっちばかりいじってた。
</p>
<!-- section end -->
</div>
<!-- 2015/06/27 end -->



<hr class="hide">
<!-- 2015/06/28 start -->
<h2><a name="20150628" href="201506c.html#20150628">2015-06-28 (Sun)</a></h2>

<div class="entry1">
<h3><a name="201506281" title="201506281" href="201506c.html#201506281">■</a> 
Sony Readerのbooks.dbのtriggerを更新</h3>
<p>
T3にしてから保存する場所をいじったらやはりauto collection triggerが機能しなくなった。<br>
面倒で放置していたが、どう考えても手でコレクションに入れるほうが<br>
もっと面倒なのでなんとかしよう。
</p>
<p>
<a href="201211b.html#201211131">sqlite3のtrigger</a>でいろいろやってるわけで、よく見ると
</p>
<pre>
WHEN new.file_path LIKE 'Sony_Reader/media/books/_%'
</pre>
<p>
となっていて、ところどころ25という謎の数字が出てくる。<br>
謎かと思ったが単にこの文字列の長さだった。
</p>
<pre>
% echo -n Sony_Reader/media/books/ | wc -c
24
</pre>
<p>
つまり何度も出てくる
</p>
<pre>
substr(new.file_path, 25, length(new.file_path) - length(new.file_name) - 25))
</pre>
<p>
はbooks/の後ろのディレクトリ名を抜き出しているわけだ。<br>
これで原因はわかった。<br>
今はSony_Reader/media/books/じゃなくて単にebooks/へ保存してるので発火しない。<br>
このあたりを調整すればいい。
</p>
<pre>
WHEN new.file_path LIKE 'ebooks/_%'
</pre>
<p>
にして、25を8にすればokだ。
</p>
<pre>
CREATE TRIGGER auto_collection_trigger AFTER INSERT ON books
WHEN new.file_path LIKE 'ebooks/%'
BEGIN
    INSERT OR IGNORE INTO collection (_id, title, source_id)
    VALUES (
        (SELECT _id FROM collection WHERE title = substr(new.file_path, 8, length(new.file_path) - length(new.file_name) - 8)),
        substr(new.file_path, 8, length(new.file_path) - length(new.file_name) - 8),
        new.source_id
    );
    INSERT INTO collections (collection_id, content_id)
    VALUES (
        (SELECT _id FROM collection WHERE title = substr(new.file_path, 8, length(new.file_path) - length(new.file_name) - 8)),
        new._id
    );
END;
</pre>
<!-- section end -->
</div>
<!-- 2015/06/28 end -->



<hr class="hide">
<!-- 2015/06/29 start -->
<h2><a name="20150629" href="201506c.html#20150629">2015-06-29 (Mon)</a></h2>

<div class="entry1">
<h3><a name="201506291" title="201506291" href="201506c.html#201506291">■</a> 
Sony Readerで著者名を元にコレクション作成</h3>
<p>
昨日のSQLを見てて
</p>
<pre>
substr(new.file_path, 8, length(new.file_path) - length(new.file_name) - 8)
</pre>
<p>
が3回も出てきていやだなと思ったが、SQLってそのあたりはどうしようもないようで。<br>
というよりそもそもこのディレクトリ名は著者名にして作っているので、<br>
だったらfile_pathから取得しなくてもauthorから得ればいい。<br>
というわけでかなりシンプルになった。
</p>
<pre>
CREATE TRIGGER auto_collection_trigger AFTER INSERT ON books
BEGIN
  INSERT OR IGNORE INTO collection (_id, title, source_id)
    VALUES ((SELECT _id FROM collection WHERE title = new.author), new.author, new.source_id);
  INSERT INTO collections (collection_id, content_id)
    VALUES ((SELECT _id FROM collection WHERE title = new.author), new._id);
END;
</pre>
<p>
これはやばい。ディレクトリ作る必要もなくなったし、さらに便利になった。
</p>
<!-- section end -->
</div>
<!-- 2015/06/29 end -->



<hr class="hide">
<!-- 2015/06/30 start -->
<h2><a name="20150630" href="201506c.html#20150630">2015-06-30 (Tue)</a></h2>

<div class="entry1">
<h3><a name="201506301" title="201506301" href="201506c.html#201506301">■</a> 
著者名を正規化</h3>
<p>
file_pathを見ないようにしたのでもはや全部が対象になった。<br>
で、著者名って自分で設定しているんだけど、<br>
空白で区切ってたりしてるのもあり2つに分かれてしまう。<br>
というわけで空白は消すことにした。
</p>
<pre>
CREATE TRIGGER auto_collection_trigger AFTER INSERT ON books
BEGIN
  INSERT OR IGNORE INTO collection (_id, title, source_id)
    VALUES ((SELECT _id FROM collection WHERE title = replace(new.author,&quot; &quot;,&quot;&quot;)),
      replace(new.author,&quot; &quot;,&quot;&quot;), new.source_id);
  INSERT INTO collections (collection_id, content_id)
    VALUES ((SELECT _id FROM collection WHERE title = replace(new.author,&quot; &quot;,&quot;&quot;)), new._id);
END;
</pre>
<p>
replaceで消すだけだが、3ヶ所まったく同じなわけでどうにもならないんかな。
</p>
<!-- section end -->
</div>
<!-- 2015/06/30 end -->

<hr>
<div>
<a href="201506b.html">&lt;Older(,)</a> | 
<a href="201507a.html">Newer(.)&gt;</a> | 
<a href="index.html">Recent(/)&gt;&gt;</a>
| <a href="index.rdf">RDF</a>
</div>

<hr>
<!-- SiteSearch Google -->
<form method=GET action="https://www.google.co.jp/search">
<p>
<input type=text name=q size=31 maxlength=255 value="">
<input type=hidden name=hl value="ja">
<input type=hidden name=ie value="UTF-8">
<input type=submit name=btnG value="Google 検索">
<input type=hidden name=domains value="jarp.does.notwork.org"><br>
<input type=radio name=sitesearch value=""> WWW を検索
<input type=radio name=sitesearch value="jarp.does.notwork.org" checked> jarp.does.notwork.org を検索 <br>
</form>

<!-- nsmm v0.6.3.2(2005/08/18) -->

<address><a href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3A;&#101;&#98;&#x61;&#110;&#64;&#x6F;&#x73;&#x2E;&#x72;&#105;&#109;&#46;&#x6F;&#x72;&#x2E;&#106;&#x70;">わたなべひろふみ</a><br>
Key fingerprint = C456 1350 085F A320 C6C8  8A36 0F15 9B2E EB12 3885<br>
      <a href="https://validator.w3.org/check?uri=referer"><img
          src="https://www.w3.org/Icons/valid-html401"
          alt="Valid HTML 4.01!" height="16" width="88"></a>

<script type="text/javascript" src="http://trackfeed.com/usr/aa7471e560.js"></script>
</address>

<script src="https://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
<!--
_uacct = "UA-101613-1";
urchinTracker();
// -->
</script>
<script src="title.js" type="text/javascript">
</script>
</body>
</html>
