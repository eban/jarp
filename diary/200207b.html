<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<title>Just another Ruby porter, 2002-7-b</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="nsmm v0.6.3.2(2005/08/18)">
<meta name="author" content="わたなべひろふみ">
<meta http-equiv="Content-Style-Type" content="text/css">
<META http-equiv="Content-Script-Type" content="text/javascript">
<link rel="stylesheet" href="../css/basic.css" type="text/css" media="all">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<link rel="icon" type="image/png" href="../favicon.png">
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://eban.github.io/jarp/diary/index.rdf">
<link rev="made" href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3A;&#101;&#98;&#x61;&#110;&#64;&#x6F;&#x73;&#x2E;&#x72;&#105;&#109;&#46;&#x6F;&#x72;&#x2E;&#106;&#x70;">
<link rel="index" href="./">
<link rel="prev" href="200207a.html">
<link rel="next" href="200207c.html">

</head>
<body>
<div><h1><span>Just another Ruby porter,</span></h1></div>

<p>〜2002年7月中旬〜</p>
<hr>
<div>
<a href="200207a.html" accesskey=",">&lt;Prev(,)</a> | 
<a href="200207c.html" accesskey=".">Next(.)&gt;</a> | 
<a href="index.html" accesskey="/">Recent(/)&gt;&gt;</a>
| <a href="index.rdf">RDF</a>
</div>

<hr>

<!-- 2002/07/11 start -->
<h2><a name="20020711" href="200207b.html#20020711">2002-07-11 (Thu)</a></h2>

<div class="entry1">
<h3><a name="200207111" title="200207111" href="200207b.html#200207111">■</a> 
研修合宿</h3>
<p>
代々木で研修合宿だ。
</p>
<!-- section end -->
</div>
<!-- 2002/07/11 end -->



<hr class="hide">
<!-- 2002/07/12 start -->
<h2><a name="20020712" href="200207b.html#20020712">2002-07-12 (Fri)</a></h2>

<div class="entry1">
<h3><a name="200207121" title="200207121" href="200207b.html#200207121">■</a> 
研修合宿</h3>
<p>
二日目。疲れた。
</p>


<!-- section end -->
</div>
<!-- 2002/07/12 end -->



<hr class="hide">
<!-- 2002/07/13 start -->
<h2><a name="20020713" href="200207b.html#20020713">2002-07-13 (Sat)</a></h2>

<div class="entry1">
<h3><a name="200207131" title="200207131" href="200207b.html#200207131">■</a> 
<a href="http://www.fefe.de/dietlibc/">[Linux] dietlibc 0.18</a></h3>
<pre>
Changes: There are new ports to x86_64 and IA64, stpcpy, expanded
large file support, better support for signals (signal now has BSD
signal semantic), a clone for PA-RISC, better support for gcc 3, and
header cleanups.
</pre>
<p>
ということなので、Rubyも変更しなくていいかと思ったが、その辺りに変化なし。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207132" title="200207132" href="200207b.html#200207132">■</a> 
<a href="http://www.ruby-lang.org/en/raa-list.rhtml?name=OptionParser">[Ruby] OptionParser 0.9</a></h3>
<p>
更新。
</p>


<!-- section end -->
</div>
<!-- 2002/07/13 end -->



<hr class="hide">
<!-- 2002/07/14 start -->
<h2><a name="20020714" href="200207b.html#20020714">2002-07-14 (Sun)</a></h2>

<div class="entry1">
<h3><a name="200207141" title="200207141" href="200207b.html#200207141">■</a> 
<a href="http://www.ruby-lang.org/en/raa-list.rhtml?name=date2">[Ruby] date2 3.3-1</a></h3>
<p>
というわけで、date.rb, parsedate.rbを足してrepackして3.3-1として更新。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207142" title="200207142" href="200207b.html#200207142">■</a> 
<a href="http://www.ruby-lang.org/en/raa-list.rhtml?name=bdb">[Ruby] bdb 0.3.2</a></h3>
<p>
更新。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200207143" title="200207143" href="200207b.html#200207143">■</a> 
<a href="http://ruby.yi.org/raa/ja/">[Ruby] YARAA Index</a></h3>
<p>
7/10の夜から死んでるようだ。WWWOFFLEのcacheだと
</p>
<pre>
更新日時: Wed Jul 10 20:00:14 JST 2002
</pre>
<p>
が最後。
<a href="http://www.ruby-lang.org/en/raa.html">本家</a>は250KBもあるのでちとつらい。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207144" title="200207144" href="200207b.html#200207144">■</a> 
B-DASH |ちょ|</h3>
<p>
歌詞に驚く。
</p>


<!-- section end -->
</div>
<!-- 2002/07/14 end -->



<hr class="hide">
<!-- 2002/07/15 start -->
<h2><a name="20020715" href="200207b.html#20020715">2002-07-15 (Mon)</a></h2>

<div class="entry1">
<h3><a name="200207151" title="200207151" href="200207b.html#200207151">■</a> 
[Ruby][Cygwin] 拡張ライブラリ</h3>
<p>
以前はCygwin上でRubyの拡張ライブラリを作るには、
まずライブラリ自身の移植から始めていたが、
もうその必要もないようだ。
DLLもそのインポートライブラリ用意されてるし、
ライブラリを静的にリンクするのはやめようかな。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207152" title="200207152" href="200207b.html#200207152">■</a> 
<a href="http://www.loveruby.net/~aamine/ja/tdiary/?date=20020714#p02">Boehm</a></h3>
<p>
残念ながら名前が違います。どう発音するのか難しい。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200207153" title="200207153" href="200207b.html#200207153">■</a> 
<a href="http://www.loveruby.net/~aamine/ja/tdiary/?date=20020714#p03">[Ruby] if /re/</a></h3>
<p>
warningになるので将来的には通らなくなるかもしれないけど、
わざわざwarn_unless_e_option()を作ってるので、
one-liner的には残るのかもしれない。
</p>
<pre>
% echo '$_=&quot;a&quot;; p true if /a/' | ruby-1.7.2
-:1: warning: regex literal in condition
true
% ruby-1.7.2 -e '$_=&quot;a&quot;; p true if /a/'
true
</pre>
<p>
で、結局は
<a href="http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-dev/14424">これ</a>ですね。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207154" title="200207154" href="200207b.html#200207154">■</a> 
<a href="http://tamura.tdiary.net/20020713.html#p03">[Ruby] cross cygwin環境</a></h3>
<p>
それはきっとgcc 3.1.1に違いない。
gcc-mingwを見ると何をすればいいかがわかるというか、
構造はbmingwとある意味そっくりだったり。
</p>


<!-- section end -->
</div>
<!-- 2002/07/15 end -->



<hr class="hide">
<!-- 2002/07/16 start -->
<h2><a name="20020716" href="200207b.html#20020716">2002-07-16 (Tue)</a></h2>

<div class="entry1">
<h3><a name="200207161" title="200207161" href="200207b.html#200207161">■</a> 
<a href="http://cygwin.com/ml/cygwin/2002-07/msg01186.html">Available for test: gcc-3.1.1-3, gcc2-2.95.3-9, gcc-mingw-3_1-20020516-2</a></h3>
<p>
やっと
<a href="200207a.html#200207083">全部</a> 解消。file.cの問題もなくなった。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207162" title="200207162" href="200207b.html#200207162">■</a> 
<a href="http://homepage1.nifty.com/markey/memo/200207.html#071302">RubyWin</a></h3>
<p>
というわけで
<a href="../files/rubywin-0.0.4.0-cygwin-gcc-3.1.1-3.patch">パッチ</a>です。
</p>


<!-- section end -->
</div>
<!-- 2002/07/16 end -->



<hr class="hide">
<!-- 2002/07/17 start -->
<h2><a name="20020717" href="200207b.html#20020717">2002-07-17 (Wed)</a></h2>

<div class="entry1">
<h3><a name="200207171" title="200207171" href="200207b.html#200207171">■</a> 
[Cygwin] Linux上にgcc 3.1.1-3のクロス環境の作る</h3>
<p>
面倒なので、ライブラリとかヘッダはCygwinのパッケージをそのまま使うことにしよう。
用意するもの:
</p>
<pre>
cygwin-1.3.12-2.tar.bz2
mingw-runtime-2.0-2.tar.bz2
w32api-1.5-1.tar.bz2
gcc-mingw-3_1-20020516-2.tar.bz2
binutils-20020706-2-src.tar.bz2
gcc-3.1.1-3-src.tar.bz2
</pre>
<p>
binutilsは特になにも準備しなくてもmake可能。
gccは途中で&lt;stdio.h&gt;が必要になるので、
あらかじめ展開してそれなりの場所に置いとく。
というわけで順番としては
</p>
<pre>
1. パッケージの展開と移動
2. binutilsのmake, install
3. gccのmake, install
</pre>
<p>
となる。とりあえずprefixは/usr/local/test/cygwinとして、全く新規に作る。
</p>
<pre>
% prefix=/usr/local/test/cygwin
% mkdir -p $prefix/i686-pc-cygwin
% tar xfv cygwin-1.3.12-2.tar.bz2 --us=bzip2 usr/{include,lib}
% tar xfv mingw-runtime-2.0-2.tar.bz2 --us=bzip2 usr/{include,lib}
% tar xfv w32api-1.5-1.tar.bz2 --us=bzip2 usr/{include,lib}
% mv usr/{include,lib} $prefix/i686-pc-cygwin
</pre>
<p>
これで準備ok。binutilsは簡単。
</p>
<pre>
% tar xfv binutils-20020706-2-src.tar.bz2 --us=bzip2
% cd binutils-20020706-2
% CFLAGS=-Os ./configure --prefix=$prefix --target=i686-pc-cygwin
% make
% make install
</pre>
<p>
Cygwin上でgcc -vした結果を参考にconfigureのオプションを決める。
</p>
<pre>
% tar xfv gcc-3.1.1-3-src.tar.bz2 --us=bzip2
% cd gcc-3.1.1-3
% mkdir cygwin; cd cygwin
% CFLAGS=-Os CXXFLAGS=-Os ../configure --enable-languages=c,c++ \
  --enable-threads=posix --with-system-zlib --enable-nls \
  --without-included-gettext --disable-shared --enable-interpreter \
  --disable-sjlj-exceptions --disable-version-specific-runtime-libs \
  --target=i686-pc-cygwin --enable-haifa --prefix=$prefix
% make
% make install
</pre>
<p>
これでCygwinはok。で、
</p>
<pre>
% touch foo.c
% i686-pc-cygwin-gcc -mno-cygwin foo.c 
i686-pc-cygwin-gcc: installation problem, cannot exec `cc1': No such file or directory
</pre>
<p>
となるのはsymlinkやその他が足りないわけだ。ここでgcc-mingwを使う。
</p>
<pre>
% mkdir -p $prefix/i686-pc-mingw32
% cd $prefix/i686-pc-mingw32
% ln -s ../i686-pc-cygwin/bin .
% ln -s ../i686-pc-cygwin/include/mingw include
% ln -s ../i686-pc-cygwin/lib/mingw lib        
% cd ~-/../..
% tar xfO gcc-mingw-3_1-20020516-2.tar.bz2 --us=bzip2 \
  etc/postinstall/gcc-mingw-3.1-20020516-1.tar | \
  tar xfv - -C $prefix
</pre>
<p>
このままだと.exeつきのsymlinkなので、.exeを削除したsymlinkを張る。
</p>
<pre>
% cd $prefix/lib/gcc-lib/i686-pc-mingw32/3.1.1
% ln -s ../../i686-pc-cygwin/3.1.1/cc1 .
% ln -s ../../i686-pc-cygwin/3.1.1/cc1plus .
% ln -s ../../i686-pc-cygwin/3.1.1/ccp0 .   
% ln -s ../../i686-pc-cygwin/3.1.1/tradcpp0 . 
</pre>
<p>
要らないsymlinkを削除。
</p>
<pre>
% rm *.exe
</pre>
<p>
これでいけるはずだ。でも-vの結果はちょっと変だな。
</p>
<pre>
ignoring nonexistent directory &quot;/usr/local/test/cygwin/i686-pc-mingw32/sys-include/usr/local/test/cygwin/lib/gcc-lib/i686-pc-mingw32/3.1.1/../../../../i686-pc-mingw32/include`@ &quot;
ignoring nonexistent directory &quot;/usr/local/test/cygwin/i686-pc-mingw32/include&quot;(
</pre>
<p>
と、なんか壊れてるっぽい。うーむ。
</p>


<!-- section end -->
</div>
<!-- 2002/07/17 end -->



<hr class="hide">
<!-- 2002/07/18 start -->
<h2><a name="20020718" href="200207b.html#20020718">2002-07-18 (Thu)</a></h2>

<div class="entry1">
<h3><a name="200207181" title="200207181" href="200207b.html#200207181">■</a> 
gcc 3.1.1-3 buffer overrun</h3>
<p>
-mno-cygwinを指定すると、&quot;-cygwin&quot;を&quot;-mingw32&quot;へ置換するようになった。
たとえばspecsのある
</p>
<pre>
$prefix/lib/gcc-lib/i686-pc-cygwin/3.1.1
</pre>
<p>
は
</p>
<pre>
$prefix/lib/gcc-lib/i686-pc-mingw32/3.1.1
</pre>
<p>
になる。これを見るとわかるように&quot;-mingw32&quot;は&quot;-cygwin&quot;より1バイト多い。
それがgcc/config/i386/cygwin.hのこのコメントの意味。
</p>
<pre>
/* Allocate space for all of the machine-spec-specific stuff.
   Allocate enough space for cygwin -&gt; mingw32 munging. */
</pre>
<p>
実体は
</p>
<pre>
char cygwin_cross_include_dir[sizeof (CROSS_INCLUDE_DIR) + 1] = CROSS_INCLUDE_DIR;
</pre>
<p>
のように1バイト余分に確保している。
しかし、1バイトじゃ足りないのだ。実際は
</p>
<pre>
$prefix/lib/gcc-lib/i686-pc-cygwin/3.1.1/../../../../i686-pc-cygwin/sys-include
</pre>
<p>
のように&quot;-cygwin&quot;が複数回現われる。2個あるから本当は2バイト必要。
3.1.1では正規化もしてるのでその後で展開すればよさそうだが、
面倒なのと3個以上は出てきそうにないので、+ 2してお茶を濁すことにする。
問題になるのはCROSS_INCLUDE_DIRとTOOL_INCLUDE_DIRの2つ。
あ、prefixに&quot;-cygwin&quot;を含ませるとすごくまずいねえ。注意。
</p>

<p>
でもこれってcrossじゃなくても起きると思うんだけど、
なぜnativeでは問題ないんだろう？違ったpath表現になるのか？
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207182" title="200207182" href="200207b.html#200207182">■</a> 
<a href="http://tamura.tdiary.net/20020718.html#p01">gcc-3.1.1でのクロス環境構築</a></h3>
<p>
あのパッチはcrossとnativeで同じbmingw packageを使えるようにするためのものなので、
ふつうに使う分には要りません。mingwの-lstdc++問題もgcc-mingwで解決できるし。
gcc-mingwの構成については、

<a href="200101a.html#200101021">これ</a>
でわかるかなあ。
</p>

<p>
もはやbmingw packageはext/etcを通すだけの単なるライブラリにすぎないので、
ext/etcとwin32/のほうへmargeしてしまう方向で考えたほうがよさそう。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200207183" title="200207183" href="200207b.html#200207183">■</a> 
<a href="200207b.html#200207171">collect2</a></h3>
<p>
あ、
</p>
<pre>
% ln -s ../../i686-pc-cygwin/3.1.1/collect2 .
</pre>
<p>
を忘れてた。
</p>


<!-- section end -->
</div>
<!-- 2002/07/18 end -->



<hr class="hide">
<!-- 2002/07/19 start -->
<h2><a name="20020719" href="200207b.html#20020719">2002-07-19 (Fri)</a></h2>

<div class="entry1">
<h3><a name="200207191" title="200207191" href="200207b.html#200207191">■</a> 
[Linux] hdparm</h3>
<p>
信じられないことに、hdparm -c 1 -d 1してないことに気づく。
というより、このPCは古すぎてDMAはサポートしてないようだ。
</p>

<p>
とりあえず32-bit I/O supportだけでもenableにしてみる。
</p>
<pre>
% sudo hdparm -t /dev/hdb  

/dev/hdb:
 Timing buffered disk reads:  32 MB in  9.42 seconds = 3.40 MB/sec
% sudo hdparm -t -c 1 /dev/hdb

/dev/hdb:
 setting 32-bit I/O support flag to 1
 I/O support  =  1 (32-bit)
 Timing buffered disk reads:  32 MB in  5.82 seconds = 5.50 MB/sec
</pre>
<p>
これだけでも結構違う。
</p>

<p>
試しにLinux 2.5.26をmake bzImageしてみる。
</p>
<pre>
PATH=/usr/bin:$PATH make SHELL=/bin/bash bzImage \
  2054.73s user 163.83s system 98% cpu 37:27.74 total
</pre>
<p>

<a href="200207a.html#200207071">前回</a> は54分。
</p>


<!-- section end -->
</div>
<!-- 2002/07/19 end -->



<hr class="hide">
<!-- 2002/07/20 start -->
<h2><a name="20020720" href="200207b.html#20020720">2002-07-20 (Sat)</a></h2>

<div class="entry1">
<h3><a name="200207201" title="200207201" href="200207b.html#200207201">■</a> 
bash 2.05b</h3>
<p>
CHANGESを見るとマルチバイト対応が入ったようだ。
</p>
<pre>
3.  New Features in Bash
&lt;snip&gt;
c.  New code to handle multibyte characters.
</pre>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200207202" title="200207202" href="200207b.html#200207202">■</a> 
Perl 5.8.0</h3>
<p>
/.-Jによるとリリースされたらしい。
例によってperl-currentをrsyncしてみるとpatchlevel.hが変だ。
</p>
<pre>
static  char    *local_patches[] = {
        NULL
        &quot;DEVEL17641&quot;,
        ,NULL
};
</pre>
<p>
これじゃ、もちろんエラーになる。
リリース時には間になにもはさまないはずだから大丈夫か。
</p>

<p>
もともとはこうなっている。
</p>
<pre>
static  char    *local_patches[] = {
        NULL
        ,NULL
};
</pre>
<p>
あまり見ない形式だ。
Cでは最後のcommaが許されるからこういう書き方は普通しない。
だからこそ起きたミスだ。
</p>

<p>
そういえば最後のjperlも
</p>
<pre>
  static        char    *local_patches[] = {
        NULL
+       ,&quot;jperl5.005_03-20000401.pat - April Fool&quot;
        ,NULL
  };
</pre>
<p>
としたんだっけ。
</p>

<p>
make testするとPerlIO/scalar.pmやPerlIO/via.pmがないと言われる。
PerlIO/Scalar.pmとPerlIO/Via.pmはあるな。typoか？
やっぱtarballを取ってこないとだめだな。11MBだと？でかすぎ。
</p>


<!-- section end -->
</div>
<!-- 2002/07/20 end -->

<hr>
<div>
<a href="200207a.html">&lt;Prev(,)</a> | 
<a href="200207c.html">Next(.)&gt;</a> | 
<a href="index.html">Recent(/)&gt;&gt;</a>
| <a href="index.rdf">RDF</a>
</div>

<hr>
<!-- SiteSearch Google -->
<form method=GET action="http://www.google.co.jp/search">
<p>
<input type=text name=q size=31 maxlength=255 value="">
<input type=hidden name=hl value="ja">
<input type=hidden name=ie value="UTF-8">
<input type=submit name=btnG value="Google 検索">
<input type=hidden name=domains value="jarp.does.notwork.org"><br>
<input type=radio name=sitesearch value=""> WWW を検索
<input type=radio name=sitesearch value="jarp.does.notwork.org" checked> jarp.does.notwork.org を検索 <br>
</form>

<!-- nsmm v0.6.3.2(2005/08/18) -->

<address><a href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3A;&#101;&#98;&#x61;&#110;&#64;&#x6F;&#x73;&#x2E;&#x72;&#105;&#109;&#46;&#x6F;&#x72;&#x2E;&#106;&#x70;">わたなべひろふみ</a><br>
Key fingerprint = C456 1350 085F A320 C6C8  8A36 0F15 9B2E EB12 3885<br>
      <a href="http://validator.w3.org/check?uri=referer"><img
          src="http://www.w3.org/Icons/valid-html401"
          alt="Valid HTML 4.01!" height="16" width="88"></a>

<script type="text/javascript" src="http://trackfeed.com/usr/aa7471e560.js"></script>
</address>

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
<!--
_uacct = "UA-101613-1";
urchinTracker();
// -->
</script>
<script src="title.js" type="text/javascript">
</script>
</body>
</html>
