<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<title>Just another Ruby porter, 2002-2-c</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="nsmm v0.6.3.2(2005/08/18)">
<meta name="author" content="わたなべひろふみ">
<meta http-equiv="Content-Style-Type" content="text/css">
<META http-equiv="Content-Script-Type" content="text/javascript">
<link rel="stylesheet" href="../css/basic.css" type="text/css" media="all">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<link rel="icon" type="image/png" href="../favicon.png">
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://jarp.does.notwork.org/diary/index.rdf">
<link rev="made" href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3A;&#101;&#98;&#x61;&#110;&#64;&#x6F;&#x73;&#x2E;&#x72;&#105;&#109;&#46;&#x6F;&#x72;&#x2E;&#106;&#x70;">
<link rel="index" href="./">
<link rel="prev" href="200202b.html">
<link rel="next" href="200203a.html">

</head>
<body>
<div><h1><span>Just another Ruby porter,</span></h1></div>

<p>〜2002年2月下旬〜</p>
<hr>
<div>
<a href="200202b.html" accesskey=",">&lt;Prev(,)</a> | 
<a href="200203a.html" accesskey=".">Next(.)&gt;</a> | 
<a href="index.html" accesskey="/">Recent(/)&gt;&gt;</a>
| <a href="index.rdf">RDF</a>
</div>

<hr>

<!-- 2002/02/21 start -->
<h2><a name="20020221" href="200202c.html#20020221">2002-02-21 (Thu)</a></h2>

<div class="entry1">
<h3><a name="200202211" title="200202211" href="200202c.html#200202211">■</a> 
Linux 2.4.18-rc2</h3>
<p>
incr/からpatch-2.4.18-rc1-rc2.bz2を取ってきた。やっぱこのほうが楽だ。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202212" title="200202212" href="200202c.html#200202212">■</a> 
<a href="http://www.ruby-lang.org/en/raa-list.rhtml?name=Win32OLE">Win32OLE 0.4.0</a></h3>
<p>
更新。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202213" title="200202213" href="200202c.html#200202213">■</a> 
Ruby Developer's Guide</h3>
<p>
来た。注文したことすら忘れてた。700ページ弱。
うーむ。
<a href="http://bocks.dhs.org/~pizman/myri/">GtkRi</a> なんてあったのか。
あ、元
<a href="http://www.ruby-lang.org/en/raa-list.rhtml?name=myri">myri</a> ってわけだ。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202214" title="200202214" href="200202c.html#200202214">■</a> 
寝坊</h3>
<p>
ピンポーンと誰か来た。ペリカン便だった。上記のRDGが来た。
というか10時過ぎてる。来なきゃ昼まで寝ていたに違いない。
おっちゃんありがとう。
でも今日は会社で10時から打ち合わせがあったんだよ。ぐふっ。
</p>


<!-- section end -->
</div>
<!-- 2002/02/21 end -->



<hr class="hide">
<!-- 2002/02/22 start -->
<h2><a name="20020222" href="200202c.html#20020222">2002-02-22 (Fri)</a></h2>

<div class="entry1">
<h3><a name="200202221" title="200202221" href="200202c.html#200202221">■</a> 
w3m Mew.png</h3>
<p>
ふとw3m Mew.pngしてみたが
</p>
<pre>
Hit any key to quit w3m:
</pre>
<p>
とつれない返事。-T image/pngもつけたらどう？やっぱ同じ。
じゃ、これでどうだ。
</p>
<pre>
% echo '&lt;img src=&quot;Mew.png&quot;&gt;' |w3m -T text/html
</pre>
<p>
やっと2匹の仔猫が出た。というかこれなら出て当たり前だな。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202222" title="200202222" href="200202c.html#200202222">■</a> 
Linux 2.4.18-rc3</h3>
<p>
更新。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202223" title="200202223" href="200202c.html#200202223">■</a> 
GCC 3.0.4</h3>
<p>
ちゃんと公約通り2ヶ月毎に出すのはすごいなあ。
</p>


<!-- section end -->
</div>
<!-- 2002/02/22 end -->



<hr class="hide">
<!-- 2002/02/23 start -->
<h2><a name="20020223" href="200202c.html#20020223">2002-02-23 (Sat)</a></h2>

<div class="entry1">
<h3><a name="200202231" title="200202231" href="200202c.html#200202231">■</a> 
@nifty</h3>
<p>
久し振りに@niftyでコメント書いた気がする。
調べてみると、去年の12月13日以来だ。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202232" title="200202232" href="200202c.html#200202232">■</a> 
<a href="http://golem.sf.net/">golem 0.0.4</a></h3>
<p>
makeanimtab.shというシェルスクリプトで
</p>
<pre>
animcount=$(( $animcount + 1 ))
</pre>
<p>
のように使われている。ashでは計算してくれないのはいいが、
単に$(())を無視するようだ。で、animcountの初期値が0なので
</p>
<pre>
0 + 1 + 1 + 1 + 1 + 1
</pre>
<p>
になり、それが
</p>
<pre>
#define NUMANIMS 0 + 1 + 1 + 1 + 1 + 1
</pre>
<p>
となれば最終的には問題なさそうだが、なぜか
</p>
<pre>
#define NUMANIMS 0 + 1 + 1 + 1 + 1 + 1 ^G
</pre>
<p>
とC-gがつく。これは流石にgccも無視はしてくれない。
しかたないので、あらかじめここだけbashで実行しておいた。
</p>

<p>
結局1時間程使って
<a href="http://icewm.sf.net">IceWM</a> に戻したのであった。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202233" title="200202233" href="200202c.html#200202233">■</a> 
Linux 2.4.18-rc4</h3>
<p>
-rc3との違いが
<a href="../files/patch-2.4.18-rc3-rc4">これだけ</a> だ。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202234" title="200202234" href="200202c.html#200202234">■</a> 
mswin32/mingw32版rubyのpopen</h3>
<p>
ruby-talkを見てるとmswin32版だとpopenが動かないという結論になってるようだけど、
そうなんだっけ？
</p>
<pre>
% c:/usr/local/bin/ruby -ve 'p IO.popen(&quot;ls&quot;).gets'
ruby 1.6.6 (2002-02-22) [i386-mingw32]
&quot;COPYING\n&quot;
</pre>
<p>
問題ないよねえ。逆はというと
</p>
<pre>
% c:/usr/local/bin/ruby -ve 'IO.popen(&quot;grep abc&quot;,&quot;w&quot;){|x|x.print &quot;abc\n&quot;}'
ruby 1.6.6 (2002-02-22) [i386-mingw32]
</pre>
<p>
あ、だめだ。Cygwin版だと
</p>
<pre>
% ruby -ve 'IO.popen(&quot;grep abc&quot;,&quot;w&quot;){|x|x.print &quot;abc\n&quot;}' 
ruby 1.6.6 (2002-02-22) [i386-cygwin]
abc
</pre>
<p>
とokだ。このことを言っているのか？1.7なら
</p>
<pre>
% c:/usr/local/bin/ruby-1.7 -ve 'IO.popen(&quot;grep abc&quot;,&quot;w&quot;){|x|x.print &quot;abc\n&quot;}'
abc
ruby 1.7.2 (2002-02-22) [i386-mingw32]
</pre>
<p>
とok。順番が違うのはバッファリングの影響なので気にしないように。
</p>

<p>
やっぱmswin32/mingw32版ruby 1.6はいけてない。
いまさらbackportして1.6をいじるのもなんだし、
_popen/_pcloseでお茶を濁すのはどうだろう？
</p>


<!-- section end -->
</div>
<!-- 2002/02/23 end -->



<hr class="hide">
<!-- 2002/02/24 start -->
<h2><a name="20020224" href="200202c.html#20020224">2002-02-24 (Sun)</a></h2>

<div class="entry1">
<h3><a name="200202241" title="200202241" href="200202c.html#200202241">■</a> 
<a href="http://www.fefe.de/dietlibc/">diet libc 0.15</a></h3>
<p>
0.15が出てたので更新。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202242" title="200202242" href="200202c.html#200202242">■</a> 
cat</h3>
<p>
存在しないファイルをcatするとSEGVるのに気づいた。
ltraceしてみると
</p>
<pre>
% ltrace cat hoge
&lt;snip&gt;
open(&quot;hoge&quot;, 0, 010000236064)                     = -1
__errno_location()                                = 0x4012fda0
error(0, 2, 0x0804ca4e, 0xbffff7fc, 0x40013c34 &lt;unfinished ...&gt;
--- SIGSEGV (Segmentation fault) ---
+++ killed by SIGSEGV +++
</pre>
<p>
またunfinishedか。原因は
<a href="200201c.html#200201272">man</a> と同じだな。
glibc-2.2.5にするとバイナリ互換じゃなくなるのか？
textutilsに含まれるコマンドを調べてみるとwcもSEGVになる。
他にもheadやtailは何も表示しない。
これもltraceしてみるとエラー表示しようとしてるんだけど、
たまたま&quot;\0&quot;だったという感じのようだ。
</p>
<pre>
% cat --version
cat (GNU textutils) 1.22
</pre>
<p>
やけに古いな。ついでだからバージョンアップしとこう。
fileutilsよりシステムに依存する部分が少ないのでdiet libcを使う。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202243" title="200202243" href="200202c.html#200202243">■</a> 
Textutils 2.0</h3>
<pre>
% tar xfvz textutils-2.0.tar.gz
% cd textutils-2.0
% mkdir diet; cd diet
% CC='diet gcc -nostdinc' ../configure --prefix=/usr --disable-nls
% make
&lt;snip&gt;
../../src/paste.c:57: storage size of `dummy_closed' isn't known
../../src/paste.c:61: storage size of `dummy_endlist' isn't known
make[2]: *** [paste.o] Error 1
</pre>
<p>
む？問題の個所は
</p>
<pre>
static FILE dummy_closed;
/* Element marking a file that has reached EOF and been closed. */
#define CLOSED (&amp;dummy_closed)

static FILE dummy_endlist;
/* Element marking end of list of open files. */
#define ENDLIST (&amp;dummy_endlist)
</pre>
<p>
だ。diet libcのFILEは
</p>
<pre>
typedef struct __stdio_file FILE;
</pre>
<p>
で、struct __stdio_file自体は公開してない。
つまりFILE *でしか使えないようになっている。
paste.cでは単に他とは違うpointerという意味で使っているだけなので
</p>
<pre>
#define CLOSED ((FILE *)-1)
#define ENDLIST ((FILE *)-2)
</pre>
<p>
でごまかすことにしよう。
これでリンク時にいろいろ文句言われるのを除いてmakeは通った。
</p>

<p>
make checkするとwcのところでどうも無限ループしてる雰囲気。
</p>
<pre>
% VERBOSE=1 make check
</pre>
<p>
するとwc -lのテストでループしてるようだ。実際に
</p>
<pre>
% echo a | src/wc -l
</pre>
<p>
をやらしてみると、確かに返ってこない。
ソースを見ると他との違いと言えばmemchrを使っているぐらいだ。
こんなもんがバグっているとも思えないしなあ。
確認の意味でlib/memchr.cを使うようにしたらちゃんと動く。
ということはdiet libcのmemchrがなんか変なのか？
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202244" title="200202244" href="200202c.html#200202244">■</a> 
diet libcのmemchr</h3>
<p>
diet libcのmemchrはi386/memchr.Sだ。
そう。Cじゃないのだよ、これが。
で、どうもmemchrの3番目の引数に0を渡したときがなんか変だということがわかったので、そのあたりを調べてみる。
</p>
<pre>
memchr:
        pushl %edi
        movl 8(%esp),%edi
        movl 12(%esp),%eax
        movl 16(%esp),%ecx
        cld

        repne scasb

        je .Lfound
        xorl %edi, %edi
        incl %edi
.Lfound:
        movl %edi, %eax
        decl %eax

        popl %edi
        ret
</pre>
<p>
なるほど。実際1番目の引数-1が返ってきてるから.Lfoundへ行ってるようだ。
となると%ecxへ代入したときに0だったら、
何もしないで直に見つからなかった処理へ行けばいいわけだ。
</p>
<pre>
memchr:
        pushl %edi
        movl 8(%esp),%edi
        movl 12(%esp),%eax
        movl 16(%esp),%ecx
        je .Lnot_found
        cld

        repne scasb

        je .Lfound
.Lnot_found:
        xorl %edi, %edi
        incl %edi
.Lfound:
        movl %edi, %eax
        decl %eax

        popl %edi
        ret
</pre>
<p>
としてみた。これでいいようだ。
</p>

<p>
というかlib/memchr.cを使えばいいだけの話ではある。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202245" title="200202245" href="200202c.html#200202245">■</a> 
ruby-dev</h3>
<p>
ruby-devはどうなってるんだ？俺達にも情報をよこせみたいな意見がruby-talkで出てる。
というかはっきり言って今やruby-talkのほうがよっぽどruby-devだよ。
逆に週一でruby-devへ情報をくれるとありがたいくらい。
</p>


<!-- section end -->
</div>
<!-- 2002/02/24 end -->



<hr class="hide">
<!-- 2002/02/25 start -->
<h2><a name="20020225" href="200202c.html#20020225">2002-02-25 (Mon)</a></h2>

<div class="entry1">
<h3><a name="200202251" title="200202251" href="200202c.html#200202251">■</a> 
Ruby with uClibc</h3>
<p>

<a href="http://www.fefe.de/dietlibc/">diet libc</a>
と来れば次は当然
<a href="http://www.uclibc.org/">uClibc</a> だ。
RubyのためにはConfigのDO_C99_MATHをtrueにしておく(ldexp)。
ちなみにRuby with diet libcは非常に面倒なので途中でやめた。
</p>

<p>
ふつう対応するにはその環境固有のpredefineなもので#ifdefしたりするわけだけど、
</p>
<pre>
% cmp =(gcc -E -dM -x c /dev/null) \
      =(/usr/i386-linux-uclibc/bin/gcc -E -dM -x c /dev/null)
% 
</pre>
<p>
と違いがない。まったくもって移植者泣かせなブツだ。
configure時にuClibcを使ってるかどうかを判断しないとだめだな。
とはいうものの、io.cのREAD_DATA_PENDING()だけ対応すればminirubyはokなので、
結構素性はいい。
random(3)はあるのにsetstate(3),initstate(3)はないというのもあるが、
とりあえず
</p>
<pre>
#undef HAVE_RANDOM
</pre>
<p>
しとく。で、肝心のREAD_DATA_PENDING()は&lt;stdio.h&gt;を見ると
</p>
<pre>
#define READ_DATA_PENDING(fp) ((fp)-&gt;bufpos &lt; (fp)-&gt;bufend)
</pre>
<p>
でよさそう。
</p>

<p>
ext/socketはgai_strerror()がconflictする。これは後回し。
</p>

<p>
make testすると
</p>
<pre>
echo: error while loading shared libraries: libdl.so.0: \
  cannot open shared object file: No such file or directory
</pre>
<p>
とメッセージが出る。./ruby sample/test.rbなら通る。なんか不思議だ。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202252" title="200202252" href="200202c.html#200202252">■</a> 
1.6.7</h3>
<p>
あ、version.hが1.6.7になってる。
</p>


<!-- section end -->
</div>
<!-- 2002/02/25 end -->



<hr class="hide">
<!-- 2002/02/26 start -->
<h2><a name="20020226" href="200202c.html#20020226">2002-02-26 (Tue)</a></h2>

<div class="entry1">
<h3><a name="200202261" title="200202261" href="200202c.html#200202261">■</a> 
Ruby with uClibc</h3>
<p>

<a href="http://www.busybox.net/">busybox</a> のソースを見てたら__UCLIBC__を発見。
&lt;feature.h&gt;で定義しているようだ。
&lt;feature.h&gt;は&lt;stdio.h&gt;でincludeされていて、
&lt;stdio.h&gt;は&quot;ruby.h&quot;でincludeされているので、
結局Rubyでは__UCLIBC__で判断できることがわかった。
randomの件も__UCLIBC__が使える。
</p>

<p>
ext/socket/{addinfo.h,getaddrinfo.c}は
</p>
<pre>
extern char *gai_strerror __P((int));
</pre>
<p>
を
</p>
<pre>
extern const char *gai_strerror __P((int));
</pre>
<p>
にすればokだ。
</p>

<p>
まつもとさんがpreview1をcommitしたら、この変更を入れよう。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202262" title="200202262" href="200202c.html#200202262">■</a> 
Linux 2.4.18</h3>
<p>
実体は-rc4そのものらしい。
というわけで、次は2.4.19-pre1か-ac1を試そうかな。
</p>


<!-- section end -->
</div>
<!-- 2002/02/26 end -->



<hr class="hide">
<!-- 2002/02/27 start -->
<h2><a name="20020227" href="200202c.html#20020227">2002-02-27 (Wed)</a></h2>

<div class="entry1">
<h3><a name="200202271" title="200202271" href="200202c.html#200202271">■</a> 
Linux 2.4.19-pre1-ac1</h3>
<p>
やけにでかいと思ったらjfsも含まれてる。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202272" title="200202272" href="200202c.html#200202272">■</a> 
ramdisk</h3>
<p>
いくらやってもramdiskを認識しないなあなどと思っていたら、.configに
</p>
<pre>
# CONFIG_BLK_DEV_RAM is no set
</pre>
<p>
と書いてあった。だめじゃん。
</p>


<!-- section end -->
</div>
<!-- 2002/02/27 end -->



<hr class="hide">
<!-- 2002/02/28 start -->
<h2><a name="20020228" href="200202c.html#20020228">2002-02-28 (Thu)</a></h2>

<div class="entry1">
<h3><a name="200202281" title="200202281" href="200202c.html#200202281">■</a> 
<a href="http://znz.s1.xrea.com/t/?date=20020227#p01">Dir.glob(&quot;*\n&quot;)</a></h3>
<p>
これは空白が区切りではなくなったことと関連してます。1.6は
</p>
<pre>
#define isdelim(c) ((c)==' '||(c)=='\t'||(c)=='\n'||(c)=='\0')
</pre>
<p>
で、1.7は
</p>
<pre>
#define isdelim(c) ((c)=='\0')
</pre>
<p>
となってます。つまり1.6では
</p>
<pre>
% touch a b
% ruby -e 'p Dir[&quot;a\nb&quot;]'
[&quot;a&quot;, &quot;b&quot;]
</pre>
<p>
と、&quot;\0&quot;じゃなくてもいいわけです。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202282" title="200202282" href="200202c.html#200202282">■</a> 
<a href="http://freshmeat.net/projects/virus/">VIrus</a></h3>
<p>

<a href="http://www.busybox.net/">busybox</a> を見てるとほんといろんなものが入ってるねえ。
ほんと感心する。viまである。で、これを独立させたのが

<a href="http://freshmeat.net/projects/virus/">VIrus</a>
なわけだが、わざわざそんな名前をつけなくても。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202283" title="200202283" href="200202c.html#200202283">■</a> 
Linux 2.4.19-pre1-ac2</h3>
<p>
更新。
</p>

<!-- section end -->
</div>

<div class="entry0">
<h3><a name="200202284" title="200202284" href="200202c.html#200202284">■</a> 
<a href="http://cygwin.com/ml/cygwin-announce/2002/msg00063.html">Cygwin 1.3.10-1</a></h3>
<p>
出たようだ。が、明日を待つことにする。
</p>

<!-- section end -->
</div>

<div class="entry1">
<h3><a name="200202285" title="200202285" href="200202c.html#200202285">■</a> 
メール配送遅延</h3>
<p>
[ruby-list:34112]から[ruby-list:34114]がまだ来ない。
もう24時間以上経ってるじゃん。rimよ、このままで大丈夫なのか？
</p>


<!-- section end -->
</div>
<!-- 2002/02/28 end -->

<hr>
<div>
<a href="200202b.html">&lt;Prev(,)</a> | 
<a href="200203a.html">Next(.)&gt;</a> | 
<a href="index.html">Recent(/)&gt;&gt;</a>
| <a href="index.rdf">RDF</a>
</div>

<hr>
<!-- SiteSearch Google -->
<form method=GET action="http://www.google.co.jp/search">
<p>
<input type=text name=q size=31 maxlength=255 value="">
<input type=hidden name=hl value="ja">
<input type=hidden name=ie value="UTF-8">
<input type=submit name=btnG value="Google 検索">
<input type=hidden name=domains value="jarp.does.notwork.org"><br>
<input type=radio name=sitesearch value=""> WWW を検索
<input type=radio name=sitesearch value="jarp.does.notwork.org" checked> jarp.does.notwork.org を検索 <br>
</form>

<!-- nsmm v0.6.3.2(2005/08/18) -->

<address><a href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3A;&#101;&#98;&#x61;&#110;&#64;&#x6F;&#x73;&#x2E;&#x72;&#105;&#109;&#46;&#x6F;&#x72;&#x2E;&#106;&#x70;">わたなべひろふみ</a><br>
Key fingerprint = C456 1350 085F A320 C6C8  8A36 0F15 9B2E EB12 3885<br>
      <a href="http://validator.w3.org/check?uri=referer"><img
          src="http://www.w3.org/Icons/valid-html401"
          alt="Valid HTML 4.01!" height="16" width="88"></a>

<script type="text/javascript" src="http://trackfeed.com/usr/aa7471e560.js"></script>
</address>

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
<!--
_uacct = "UA-101613-1";
urchinTracker();
// -->
</script>
<script src="title.js" type="text/javascript">
</script>
</body>
</html>
